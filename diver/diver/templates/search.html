{% extends 'base.html' %}

{% load staticfiles %}
{% block styletags %}
<link rel="stylesheet" type="text/css" href="{% static 'css/search.css' %}">
{% endblock %}

{% block content %}
<h1>추천 받기</h1>
<div class="row">
  <div class="col-md-2">
    <h3>검색 필터 설정</h3>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      {% include "category_select.html" %}

      <div class="form-group">
        <label for="lower">가격 하한선</label>
        <input name="lower" class="form-control" type="number" id="lower" value="{{ lower }}">
      </div>
      <div class="form-group">
        <label for="upper">가격 상한선 (상한 없음: 0)</label>
        <input name="upper" class="form-control" type="number" id="upper" value="{{ upper }}">
      </div>
      <input type="submit" id="send" value="검색!" class="btn btn-primary"/>
    </form>
  </div>
  <div class="col-md-10">
    {% load item_filters %}
    {% if search_result %}
      {% for item in search_result %}
        <div class="item-view col-md-5"
            data-item-id="{{ item.id }}"
            data-item-category1="{{ item.category|category1 }}"
            data-item-category2="{{ item.category }}">
          <img src="{{ item.images }}">
          <span>{{ item.name }}</span>
          <span>{{ item.price }}</span>
          <span class="button-to-hanger"><a href="#">To hanger</a></span>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  <div id="hanger">
    <h3>My hanger</h3>
    <div class="hanger-slot outer-slot" data-accepts="OUTER">{% hanger_item hanger "OUTER" 0 %}</div>
    <div class="hanger-slot outer-slot" data-accepts="OUTER">{% hanger_item hanger "OUTER" 1 %}</div>
    <div class="hanger-slot top-slot" data-accepts="TOP">{% hanger_item hanger "TOP" 0 %}</div>
    <div class="hanger-slot top-slot" data-accepts="TOP">{% hanger_item hanger "TOP" 1 %}</div>
    <div class="hanger-slot bottom-slot" data-accepts="BOTTOM">{% hanger_item hanger "BOTTOM" 0 %}</div>
    <div class="hanger-slot shoes-slot" data-accepts="SHOE">{% hanger_item hanger "SHOE" 0 %}</div>
  </div>
</div>
{% endblock %}
{% block script %}
<script>
$( function(){
  $(".button-to-hanger a").click( function(e) {
    item = $(e.target.parentElement.parentElement);
    available_slots = $(`.hanger-slot:not(:has(*))[data-accepts="${item.data("item-category1").toUpperCase()}"]`)
    if(available_slots.length > 0){
      available_slots.first().append(item.clone());
      $.ajax( {
        type: 'POST',
        url: '{% url 'update_hanger' %}',
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            action: 'ADD',
            item_id: item.data("item-id")
        }
      });
    } else {
      alert("Hanger is full!");
    }
  });
});
</script>
{% endblock %}
